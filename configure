#!/bin/sh
# configure script for the grpc R package
set -eu

# Handle --clean invocations from R CMD INSTALL --clean
for arg in "$@"; do
  case "$arg" in
    --clean)
      rm -f src/Makevars
      exit 0
      ;;
  esac
done

PKG_CONFIG=${PKG_CONFIG:-pkg-config}
if ! command -v "$PKG_CONFIG" >/dev/null 2>&1; then
  cat >&2 <<EOF
configure: error: pkg-config is required to locate gRPC headers and libraries.
Please install pkg-config and ensure it can find grpc and grpc++.
EOF
  exit 1
fi

grpc_cflags=$("$PKG_CONFIG" --cflags grpc grpc++ 2>/dev/null || true)
grpc_libs=$("$PKG_CONFIG" --libs grpc++ grpc 2>/dev/null || true)

if [ -z "$grpc_cflags" ] || [ -z "$grpc_libs" ]; then
  cat >&2 <<EOF
configure: error: pkg-config could not find grpc/grpc++.
Ensure grpc is installed and provides pkg-config metadata.
EOF
  exit 1
fi

# Strip non-portable warning suppression flags that trigger NOTE on check.
clean_cflags=$(printf '%s\n' "$grpc_cflags" | sed -E 's/(^| )-Wno-[^ ]+//g')

cat > src/Makevars <<EOF
## Generated by configure -- do not edit by hand.
CXX_STD = CXX17
PKG_CPPFLAGS = $clean_cflags
PKG_LIBS = $grpc_libs
EOF

exit 0
